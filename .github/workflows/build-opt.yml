# OpenWrt GitHub Actions æ„å»ºé…ç½®
# ä¼˜åŒ–ç‰ˆæœ¬ï¼š2024.05 ç£ç›˜å¢å¼ºç‰ˆ
# ä¸»è¦æ”¹è¿›ï¼šæ·±åº¦ç£ç›˜æ¸…ç†ã€å¹¶è¡Œç¼–è¯‘ã€ç¼“å­˜æ§åˆ¶

name: OpenWrt Builder (Optimized)

on:
  repository_dispatch:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥è‡ªåŠ¨æ„å»º

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  CACHE_VERSION: v1  # ç¼“å­˜ç‰ˆæœ¬æ§åˆ¶
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360  # 6å°æ—¶è¶…æ—¶

    steps:
    # ç£ç›˜ç©ºé—´é¢„æ¸…ç†
    - name: Free Disk Space (Pre)
      uses: jlumbroso/free-disk-space@v1.3.0
      with:
        tool-cache: true
        android: true
        dotnet: true
        swap-storage: true
        large-packages: true

    # åŸºç¡€ç¯å¢ƒå‡†å¤‡
    - name: Checkout
      uses: actions/checkout@main

    - name: Initialize Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # ç³»ç»Ÿæ¸…ç†
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo docker image prune -af --filter "until=24h"
        sudo apt-get -qq purge azure-cli google-cloud-sdk google-chrome-stable firefox powershell
        
        # åŸºç¡€ä¾èµ–å®‰è£…
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y --no-install-recommends \
          build-essential ccache git libssl-dev python3-pip wget \
          time cpio libncurses5-dev zlib1g-dev gawk file
        
        # ç£ç›˜ç›‘æ§
        echo "=== ç£ç›˜ä½¿ç”¨æƒ…å†µ ==="
        df -hT /
        sudo du -sh /workdir 2>/dev/null || echo "/workdir not exist"

    # ç¼“å­˜å¤„ç†
    - name: Cache Setup
      uses: actions/cache@v3
      with:
        path: |
          ~/.ccache
          /workdir/openwrt/dl
        key: ${{ runner.os }}-openwrt-${{ env.CACHE_VERSION }}-${{ hashFiles('**/feeds.conf.default') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-${{ env.CACHE_VERSION }}-

    # ä»£ç å…‹éš†ï¼ˆæµ…å…‹éš†ï¼‰
    - name: Clone Source Code
      working-directory: /workdir
      run: |
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    # è‡ªå®šä¹‰é…ç½®åŠ è½½
    - name: Load Custom Feeds
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
        chmod +x $DIY_P1_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH || true

    # ä¾èµ–æ›´æ–°
    - name: Update Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a || true
        ./scripts/feeds install -a

    # é…ç½®åŠ è½½
    - name: Load Configuration
      run: |
        [ -e files ] && mv files openwrt/files
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
        chmod +x $DIY_P2_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH || true

    # ç¼–è¯‘å‰å‡†å¤‡
    - name: Download Packages
      id: package
      run: |
        cd openwrt
        make defconfig
        
        # ä½¿ç”¨ccacheåŠ é€Ÿç¼–è¯‘
        export CCACHE_DIR=~/.ccache
        export CCACHE_COMPRESS=1
        export CCACHE_MAXSIZE=500M
        ccache -s 2>/dev/null || echo "ccache not initialized"
        
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    # æ ¸å¿ƒç¼–è¯‘æ­¥éª¤
    - name: Compile Firmware
      id: compile
      run: |
        cd openwrt
        
        # å¯åŠ¨ç¼–è¯‘è®¡æ—¶
        START_TIME=$(date +%s)
        
        # å¹¶è¡Œç¼–è¯‘ï¼ˆè‡ªåŠ¨æ£€æµ‹CPUæ ¸å¿ƒæ•°ï¼‰
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 || make -j1 V=s
        
        # ç¼–è¯‘æ—¶é—´ç»Ÿè®¡
        COMPILE_TIME=$(( $(date +%s) - START_TIME ))
        echo "ç¼–è¯‘è€—æ—¶: $((COMPILE_TIME/60))åˆ†$((COMPILE_TIME%60))ç§’"
        
        # ç”Ÿæˆè®¾å¤‡æ ‡è¯†
        echo "status=success" >> $GITHUB_OUTPUT
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    # ç£ç›˜ç©ºé—´åæ¸…ç†
    - name: Free Disk Space (Post)
      if: always()
      run: |
        echo "=== æ¸…ç†å‰ç£ç›˜ ==="
        df -hT /
        
        # æ·±åº¦æ¸…ç†
        sudo rm -rf /workdir/openwrt/build_dir/*
        sudo rm -rf /workdir/openwrt/tmp/*
        sudo rm -rf ~/.cache/pip
        
        # æ¸…ç†dockeræ®‹ç•™
        sudo docker system prune -af --volumes
        
        echo "=== æ¸…ç†åç£ç›˜ ==="
        df -hT /

    # æˆæœå¤„ç†
    - name: Organize Firmware
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages sha256sums
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    # å‘å¸ƒå¤„ç†
    - name: Generate Release Tag
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "release_tag=OpenWrt-$(date +"%Y.%m.%d")" >> $GITHUB_OUTPUT
        echo "ğŸ“… æ„å»ºæ—¶é—´: $(date)" > release.txt
        echo "ğŸ–¥ï¸ è®¾å¤‡ç±»å‹: $(cat ../.config | grep CONFIG_TARGET.*DEVICE | cut -d'"' -f2)" >> release.txt
        echo "ğŸ› ï¸ ç¼–è¯‘è€—æ—¶: $((COMPILE_TIME/60))åˆ†$((COMPILE_TIME%60))ç§’" >> release.txt

    # ä¸Šä¼ åˆ°Artifact
    - name: Upload Firmware
      uses: actions/upload-artifact@v3
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_Firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}/*
        retention-days: 7

    # åˆ›å»ºRelease
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*
        draft: false
        prerelease: false

    # æ¸…ç†æ—§ç‰ˆæœ¬
    - name: Clean Old Releases
      uses: dev-drprasad/delete-older-releases@v0.2.1
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # å·¥ä½œæµæ¸…ç†
    - name: Delete Workflow Runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        retain_days: 7
        keep_minimum_runs: 2
