name: Build OpenWrt by rucbarm

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 支持手动触发（推荐）

jobs:
  build:
    runs-on: ubuntu-latest-xl  # 大磁盘模式（100GB，解决空间不足）
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: rucbarm/Actions-OpenWrt  # 拉取原项目源码
          fetch-depth: 1

      - name: Free Up Disk Space (Critical Fix)
        run: |
          sudo apt-get autoremove -y && sudo apt-get clean
          docker system prune -af
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /var/lib/apt/lists/*
          sudo rm -rf /tmp/* /var/tmp/*
          df -h  # 验证空间

      - name: Initialization Environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget curl

      - name: Load Custom Configuration
        run: |
          # 替换为你的自定义配置（关键！从原项目 fork 后，修改此处或上传 .config 到仓库）
          # 方式1：直接使用原项目默认配置（注释下面两行）
          # 方式2：使用自定义 .config（将你的配置文件命名为 config.seed 放在仓库根目录）
          [ -f config.seed ] && mv config.seed .config || wget -O .config https://raw.githubusercontent.com/rucbarm/Actions-OpenWrt/main/config.seed
          # 自动补全配置
          make defconfig

      - name: Update Feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Download Packages
        run: make download -j8 V=s

      - name: Build Firmware
        run: make -j8 V=s  # 8线程编译（适配大磁盘机型）

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-Firmware
          path: bin/targets/**/*
          retention-days: 7

      - name: Delete Workflow Runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 1
          keep_minimum_runs: 1
