name: OpenWrt CI Build (v4 Artifact)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©0ç‚¹è‡ªåŠ¨æ„å»º

env:
  REPO_URL: https://github.com/coolsnowwolf/lede  # æºç ä»“åº“
  REPO_BRANCH: master                             # åˆ†æ”¯
  FEEDS_CONF: feeds.conf.default                  # feedsé…ç½®æ–‡ä»¶
  CONFIG_FILE: .config                            # ç¼–è¯‘é…ç½®æ–‡ä»¶
  DIY_P1_SH: diy-part1.sh                         # è‡ªå®šä¹‰è„šæœ¬1
  DIY_P2_SH: diy-part2.sh                         # è‡ªå®šä¹‰è„šæœ¬2
  UPLOAD_FIRMWARE: true                           # æ˜¯å¦ä¸Šä¼ å›ºä»¶
  UPLOAD_RELEASE: true                            # æ˜¯å¦å‘å¸ƒRelease
  CACHE_VERSION: v4                               # ç¼“å­˜ç‰ˆæœ¬æ ‡è¯†
  TZ: Asia/Shanghai                               # æ—¶åŒº

jobs:
  build:
    runs-on: ubuntu-22.04  # ä½¿ç”¨æœ€æ–°GitHub Actionsé•œåƒ
    timeout-minutes: 360             # è¶…æ—¶æ—¶é—´

    steps:
      # 1. ç£ç›˜ç©ºé—´æ¸…ç†ï¼ˆé¢„å¤„ç†ï¼‰
      - name: Free Disk Space (Pre)
        uses: jlumbroso/free-disk-space@v1.3.0
        with:
          tool-cache: true
          android: true
          dotnet: true
          swap-storage: true
          large-packages: true

      # 2. æ£€æŸ¥ä»£ç åº“
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 3. ç¼“å­˜è®¾ç½®ï¼ˆv4ä¼˜åŒ–ï¼‰
      - name: Cache Setup
        uses: actions/cache@v4
        with:
          path: |
            ~/.ccache
            /workdir/openwrt/dl
          key: ${{ runner.os }}-openwrt-${{ env.CACHE_VERSION }}-${{ hashFiles('**/feeds.conf.default') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-${{ env.CACHE_VERSION }}-

      # 4. å…‹éš†æºç 
      - name: Clone Source Code
        working-directory: /workdir
        run: |
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
          git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      # 5. è‡ªå®šä¹‰é…ç½®ï¼ˆå¯é€‰ï¼‰
      - name: Apply Custom Configuration
        if: env.DIY_P1_SH != ''
        run: |
          cd openwrt
          chmod +x ${{ env.DIY_P1_SH }}
          ./${{ env.DIY_P1_SH }}

      # 6. æ›´æ–°feeds
      - name: Update Feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 7. ç”Ÿæˆé…ç½®æ–‡ä»¶
      - name: Generate Config File
        run: |
          cd openwrt
          make defconfig
          cp ${{ env.CONFIG_FILE }} .config
          make menuconfig
          # ä¿å­˜é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
          # cp .config $GITHUB_WORKSPACE/${{ env.CONFIG_FILE }}

      # 8. ç¼–è¯‘å›ºä»¶
      - name: Compile Firmware
        id: compile
        run: |
          cd openwrt
          echo "COMPILE_START_TIME=$(date +%s)" >> $GITHUB_ENV
          make -j$(nproc) || make -j1 || make -j1 V=s
          echo "COMPILE_END_TIME=$(date +%s)" >> $GITHUB_ENV
          echo "DEVICE_NAME=_$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/')" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      # 9. ç£ç›˜ç©ºé—´æ¸…ç†ï¼ˆåå¤„ç†ï¼‰
      - name: Free Disk Space (Post)
        if: always()
        run: |
          sudo rm -rf /workdir/openwrt/{build_dir,tmp}
          sudo docker system prune -af --volumes

      # 10. ä¸Šä¼ å›ºä»¶ï¼ˆv4å‡çº§ï¼‰
      - name: Upload Firmware Artifact
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt_Firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: openwrt/bin/targets/*/*/*
          retention-days: 7
          if-no-files-found: error  # ä¸¥æ ¼æ¨¡å¼ï¼Œæ— æ–‡ä»¶æ—¶æŠ¥é”™

      # 11. å‘å¸ƒReleaseï¼ˆå¯é€‰ï¼‰
      - name: Create GitHub Release
        if: env.UPLOAD_RELEASE == 'true' && success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: OpenWrt_${{ env.FILE_DATE }}
          body: |
            ğŸ“… æ„å»ºæ—¶é—´: $(date)
            ğŸ–¥ï¸ è®¾å¤‡ç±»å‹: ${{ env.DEVICE_NAME }}
            â±ï¸ ç¼–è¯‘è€—æ—¶: $(( (${{ env.COMPILE_END_TIME }} - ${{ env.COMPILE_START_TIME }} ) / 60 )) åˆ†é’Ÿ
          files: openwrt/bin/targets/*/*/*
          draft: false
          prerelease: false

      # 12. å·¥ä½œæµæ¸…ç†
      - name: Cleanup Workflow
        if: always()
        run: |
          sudo rm -rf /workdir
          sudo swapoff /swapfile
          sudo rm -rf /swapfile
